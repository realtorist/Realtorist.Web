name: Build & Publish

on:
  push:
    branches: [ master ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GITHUB_USER: ${{ secrets.SECRET_GITHUB_USER }}
      NUGET_PAT: ${{ secrets.SECRET_NUGET_PAT }}
    steps:
    - uses: actions/checkout@v2
    - name: Download main application
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: publish.yml
        branch: master
        event: push
        name: Realtorist.Web.Application
        path: Extensions/Application
        repo: realtorist/Realtorist.Web.Application
    - name: Download admin application
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: publish.yml
        branch: master
        event: push
        name: Realtorist.Web.Admin.Application
        path: Extensions/Admin
        repo: realtorist/Realtorist.Web.Admin.Application
    - name: Download theme
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: publish.yml
        branch: master
        event: push
        name: Realtorist.Web.Themes.Default
        path: Extensions/Theme
        repo: realtorist/Realtorist.Web.Themes.Default
    - name: Download LetsEncrypt
      uses: dawidd6/action-download-artifact@v2
      with:
        github_token: ${{secrets.GITHUB_TOKEN}}
        workflow: publish.yml
        branch: master
        event: push
        name: Realtorist.Web.LetsEncrypt
        path: Extensions/LetsEncrypt
        repo: realtorist/Realtorist.Web.LetsEncrypt
    - name: Build docker image
      run: docker-compose build
    - name: Tag docker image version
      run: docker tag ghcr.io/realtorist/realtorist:latest ghcr.io/realtorist/realtorist:$GITHUB_RUN_NUMBER
    - name: Push image (latest)
      run: docker push ghcr.io/realtorist/realtorist:latest
    - name: Push image (version)
      run: docker push ghcr.io/realtorist/realtorist:GITHUB_RUN_NUMBER
